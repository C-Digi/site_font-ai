# Context

## 1) Previous Conversation

- User requested an investigation of whether replacing current text-only RAG embeddings with Qwen VL embeddings would improve font retrieval, using both text and rendered glyph-sheet images.
- User also asked if local inference is feasible on 2× RTX 3090 + NVLink.
- Work progressed through:
  - Initial architectural assessment and feasibility analysis.
  - Creation of an offline A/B/C evaluation harness.
  - Toy dataset validation.
  - Real 200-font evaluation.
  - GPU 8B rerun and result logging.
  - Clarification of evaluation vocabulary (alpha, recall, MRR, @K).
  - Additional ablation request: **B2 vs B2-plus**.
- User preferences captured:
  - Wants practical recommendations, not just theory.
  - Wants concise explanations of metrics.
  - Wants benchmark evidence before production choice.

Architectural decisions made during the session:
- Favor a production default of B2 (single multimodal retrieval) unless dual-channel fusion shows clear top-K benefit.
- Keep Hybrid C as optional/feature-flag path because it increases complexity (dual retrieval + score fusion).
- Use correctness-first VL embedding path via Transformers + qwen-vl-utils.

Rejected/deferred alternatives:
- Immediate full product migration without benchmark validation.
- Treating proxy-label benchmark as final proof of visual-intent quality.

## 2) Current Work

- Objective prior to this handoff request: execute and report **B2 vs B2-plus** ablation on the existing 200-font framework.
- Completion phase: research/evaluation phase is functionally complete for this cycle (~95%).
- Active mode: Orchestrator.
- Latest reported outcome (from delegated subtask): B2 remains preferred over B2-plus for top-10 retrieval.

## 3) Key Technical Concepts

Tech stack and conventions in this repo:
- Next.js + TypeScript app stack and Supabase vector search are defined in project docs and code paths such as [`route.ts`](src/app/api/search/route.ts:1), [`embeddings.ts`](src/lib/ai/embeddings.ts:1), and migration files like [`003_upgrade_vector_dimension.sql`](supabase/migrations/003_upgrade_vector_dimension.sql:1).
- Current baseline embedding call uses OpenRouter model in [`generateEmbedding()`](src/lib/ai/embeddings.ts:4).
- Seed-time text construction pattern is in [`seed-fonts.ts`](scripts/seed-fonts.ts:193).

Evaluation concepts used:
- **A**: text-only baseline embeddings.
- **B1**: VL image-only.
- **B2**: VL image + concise metadata text.
- **B2-plus**: VL image + expanded text payload (A-equivalent richer text fields).
- **C**: hybrid fusion of A and B2 scores.
- **Alpha (α)**: weight in fusion `C = α·A + (1-α)·B2`.
- **Alpha sweep**: testing many α values to find best metric point.
- **Recall@K**: fraction of relevant results retrieved in top K.
- **MRR@K**: rewards earlier rank of first relevant hit; higher is better.

Environment/constraints discovered:
- Windows + PowerShell workflow.
- GPU availability affects runtime materially.
- Optional performance dependencies (e.g., flash-attn) may be brittle on Windows.
- Benchmark labels are metadata-derived proxies; not full human visual-intent labels.

## 4) Relevant Files and Code (File System Impact Registry)

### Product baseline files examined for grounding

- [`embeddings.ts`](src/lib/ai/embeddings.ts:1)
  - Baseline embedding API logic and model selection.
  - Critical symbol: [`generateEmbedding()`](src/lib/ai/embeddings.ts:4).

- [`route.ts`](src/app/api/search/route.ts:1)
  - Search API orchestration for embedding + vector retrieval.
  - Critical symbol: [`POST()`](src/app/api/search/route.ts:37).

- [`seed-fonts.ts`](scripts/seed-fonts.ts:1)
  - Seed-time context string assembly used as A-equivalent text schema.

- [`003_upgrade_vector_dimension.sql`](supabase/migrations/003_upgrade_vector_dimension.sql:1)
  - Vector dimension and RPC updates for retrieval.

### Research and planning documents created/updated

- [`2026-02-04_qwen3-vl-embedding_assessment.md`](_05_guides/2026-02-04_qwen3-vl-embedding_assessment.md:1)
  - Initial technical assessment of replacing/augmenting baseline embeddings.

- [`2026-02-05_offline-ab-eval-plan_qwen3-vl.md`](_05_guides/2026-02-05_offline-ab-eval-plan_qwen3-vl.md:1)
  - Evaluation plan and metric definitions.

- [`README.md`](research/ab-eval/README.md:1)
- [`RUNBOOK.md`](research/ab-eval/RUNBOOK.md:1)
- [`PROGRESS.md`](research/ab-eval/PROGRESS.md:1)
- [`DECISIONS.md`](research/ab-eval/DECISIONS.md:1)

### Evaluation scripts created/updated

- [`render_glyph_sheet.py`](research/ab-eval/py/render_glyph_sheet.py:1)
  - Deterministic font image rendering for multimodal docs.

- [`embed_openrouter_text.py`](research/ab-eval/py/embed_openrouter_text.py:1)
  - Variant A embedding generation.

- [`embed_qwen3_vl.py`](research/ab-eval/py/embed_qwen3_vl.py:1)
  - Local VL embedding utility/smoke flow.

- [`embed_qwen3_vl_batch.py`](research/ab-eval/py/embed_qwen3_vl_batch.py:1)
  - Batch embeddings for B variants.
  - Latest reported change: added **B2-plus** payload path.

- [`score_retrieval.py`](research/ab-eval/py/score_retrieval.py:1)
  - Baseline scoring utility.

- [`score_all_variants.py`](research/ab-eval/py/score_all_variants.py:1)
  - Multi-variant scoring + hybrid sweep.
  - Latest reported change: includes B2-plus scoring/reporting.

- [`run_all.py`](research/ab-eval/py/run_all.py:1)
- [`run_all_text.py`](research/ab-eval/py/run_all_text.py:1)

### Data and output artifacts

- Datasets:
  - [`corpus.toy.json`](research/ab-eval/data/corpus.toy.json:1)
  - [`queries.toy.json`](research/ab-eval/data/queries.toy.json:1)
  - [`labels.toy.json`](research/ab-eval/data/labels.toy.json:1)
  - [`corpus.200.json`](research/ab-eval/data/corpus.200.json:1)
  - [`queries.200.json`](research/ab-eval/data/queries.200.json:1)
  - [`labels.200.json`](research/ab-eval/data/labels.200.json:1)

- Reports and status:
  - [`LATEST_RESULTS.md`](research/ab-eval/out/LATEST_RESULTS.md:1)
  - [`report_all.md`](research/ab-eval/out/report_all.md:1)
  - [`ablation_b2_plus.md`](research/ab-eval/out/ablation_b2_plus.md:1) *(reported created by subtask)*
  - [`ablation_b2_plus.json`](research/ab-eval/out/ablation_b2_plus.json:1) *(reported created by subtask)*

### Handoff files created in this session

- [`2026-02-06T03-56-07_handoff.md`](2026-02-06T03-56-07_handoff.md:1)
- [`2026-02-06T07-28-41_handoff.md`](2026-02-06T07-28-41_handoff.md:1)

## 5) Problem Solving

Solved problems:
- Established a reproducible evaluation framework from dataset generation to scoring and reporting.
- Confirmed that B2 materially outperformed A in prior runs.
- Clarified that Hybrid C is dual-channel score fusion, not a single multimodal embedding call.
- Completed additional ablation request (B2 vs B2-plus) via delegation and logged recommendation.

Troubleshooting/events during session:
- Earlier scoring robustness issue for small toy sets was handled in prior work.
- Windows/GPU dependency realities (including optional acceleration packages) were accounted for pragmatically.

Known bugs/edge cases:
- No new blocking bug reported in final ablation cycle.
- Proxy labels can overestimate/underestimate “true visual intent” relevance.

Validation and quality state:
- Validation is benchmark-script based (no formal unit/integration test suite in this repo for this research path).
- Latest reported ablation metrics (B2 vs B2-plus):
  - B2: Recall@10 0.3604, Recall@20 0.5549, MRR@10 1.0000
  - B2-plus: Recall@10 0.3509, Recall@20 0.5579, MRR@10 1.0000
- Outcome: B2 favored for top-10 retrieval quality and simplicity.

## 6) Pending Tasks and Next Steps

Roadmap (remaining):
- Implement production retrieval path using B2 payload strategy in app pipeline.
- Keep Hybrid C as optional feature-flag for deeper-recall use cases.
- Add a human-labeled visual-intent eval set to de-risk proxy-label bias before final long-term lock-in.
- Plan migration strategy for embeddings/indexing in Supabase and caching behavior.

Verbatim last instruction before this handoff request:

> "ok, Run one more ablation: B2 vs B2-plus"

Immediate next action:
- Apply product code changes to adopt B2 payload in production search/seed flow, then run the app-level validation path.
- Specific next operation should be a delegated implementation task via [`new_task`](.kilocode:1) to Code mode to:
  - wire B2 embedding generation into relevant backend paths,
  - update documentation and migration notes,
  - and produce an implementation summary with changed files.

Handoff risks:
- Required environment variables for baseline and/or hybrid paths (e.g., OpenRouter keys) may gate local runs.
- GPU/CUDA environment differences can change throughput and runtime.
- If dual-channel Hybrid C is later enabled, ensure scoring normalization is stable across channels.
- Do not treat proxy-label gains as final proof of visual quality without human-labeled validation.

