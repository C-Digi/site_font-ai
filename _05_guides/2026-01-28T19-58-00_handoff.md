# AI Font Explorer Handoff Summary - 2026-01-28

## Context

### Previous Conversation
- **High-Level Flow**: The project was initialized as a Next.js 15+ application. A static HTML/JS prototype was provided and migrated into a modular React architecture using the App Router.
- **Architectural Decisions**: 
    - **Tech Stack**: Next.js, Tailwind CSS v4, Supabase (Vector), Google Gemini API.
    - **AI Model**: Switched from `gemini-2.0-flash-exp` to `gemini-1.5-flash`, and finally to `gemini-2.0-flash-lite-preview-02-05` to ensure stability and compatibility with JSON mode.
    - **Data Strategy**: Implemented a Supabase Vector schema for RAG (Retrieval-Augmented Generation) and semantic caching.
    - **Environment**: Used `dotenv` with `override: true` in API routes and scripts to resolve a conflict where a suspended `GEMINI_API_KEY` in the system's shell environment was overriding the `.env.local` file.

### Current Work
- **Status**: The core UI is functional, the database schema is initialized, and the font seeding script has been executed successfully.
- **Completion Phase**: ~60% (Foundational UI and AI integration complete; RAG logic and Monetization pending).
- **Active Mode**: Software Engineering / Full Implementation.

### Key Technical Concepts
- **Tailwind v4**: Uses the new `@import "tailwindcss"` syntax and `@tailwindcss/postcss` plugin.
- **Google Fonts Integration**: Dynamic loading of font families via `<link>` tags in the `FontExplorer` component based on AI results.
- **Semantic Search**: Uses `embedding-001` (768 dimensions) to match the Supabase `vector(768)` columns.
- **Strict JSON AI**: The system prompt enforces raw JSON output (no markdown wrappers) to ensure reliable parsing in the API route.

## Relevant Files and Code (Impact Registry)

- **`src/app/api/search/route.ts`**:
    - Handles Gemini interactions.
    - Explicitly overrides environment variables to ensure the correct API key is used.
    ```typescript
    dotenv.config({ path: ".env.local", override: true });
    const model = genAI.getGenerativeModel({
      model: "gemini-2.0-flash-lite-preview-02-05", 
    });
    ```

- **`src/components/FontExplorer.tsx`**:
    - Main container managing chat history, font results, and preview state.
    - Injects Google Font families dynamically.

- **`supabase/migrations/001_init.sql`**:
    - Database schema for `fonts` and `searches` (semantic cache).
    - Includes `match_fonts` RPC for similarity search.

- **`scripts/seed-fonts.ts`**:
    - Ingestion script that fetches font metadata and generates embeddings.
    - Successfully seeded initial fonts (Roboto, Playfair Display, Montserrat).

- **`src/app/globals.css`**:
    - Configured for Tailwind v4 and preserves the custom scrollbar and loader styles from the original UI.

- **`.vscode/settings.json`**:
    - Suppresses VS Code warnings for `@tailwind` directives.

## Problem Solving
- **Solved Build Errors**: Resolved a "Can't resolve 'tailwindcss'" error by installing `@tailwindcss/postcss` and upgrading to Tailwind v4.1.18.
- **Solved Type Errors**: Fixed path alias issues in `tsconfig.json` by adding `baseUrl` and `paths`.
- **Solved API Forbidden (403)**: Discovered that the shell environment had a suspended API key that was overriding `.env.local`. Fixed by forcing `dotenv` to override.
- **Solved API Not Found (404)**: Identified that `gemini-1.5-flash` was not recognized in the `v1beta` endpoint in some regions; resolved by moving to `gemini-2.0-flash-lite-preview-02-05`.
- **Validation State**: `npx tsc --noEmit` passes. `npm run build` passes.

## Pending Tasks and Next Steps
- **RAG Implementation**: Update `src/app/api/search/route.ts` to check the Supabase `searches` table for semantic cache hits before calling Gemini.
- **Real Data Ingestion**: Update `scripts/seed-fonts.ts` to fetch the full 1000+ fonts from the Google Fonts API instead of using mocks.
- **Monetization**: Integrate Lemon Squeezy webhooks to manage credit balances.
- **Usage Limiting**: Implement the FingerprintJS middleware to enforce the 5-search/day limit for guests.

- **Verbatim Last Instruction**: "i set up supabase, update .env.local - fix the above then run the npx tsx command"
- **Immediate Next Action**: Implement the semantic cache check in `src/app/api/search/route.ts` using the `match_searches` function in Supabase.

### Handoff Risks
- **Supabase Connectivity**: Ensure the user's Supabase instance has the `vector` extension enabled via the SQL editor.
- **API Key**: The user must keep their `GEMINI_API_KEY` in `.env.local` as the shell environment may still contain a suspended key.
